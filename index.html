<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GOAP</title>
    <meta name="description" content="a revolt.chat client that hates you">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png"
        href="./favicon.png">
    <!--<script src="https://js.hcaptcha.com/1/api.js" async defer></script>-->
</head>
<body>
    <section class="login-section">
        <h1 class="login-logo">.\ /.</h1>
        <h2 class="name">goap</h2>
        <h4 class="desc">The revolt.chat client that hates you :)</h4>

        <form class="login-form">
            <h4 id="loginerror" hidden="false"></h4>
            <input class="login-put" id="token" type="password" autocomplete="on" placeholder="Token">
            <button id="loginBtn" onclick="login();">Login</button>
        </form>
            <!--
            <div id="innercontainer">
                <input id="email" autocomplete="on" placeholder="Email address">
                <input id="password" autocomplete="on" placeholder="Password" type="password">
                <div class="h-captcha" data-sitekey="3daae85e-09ab-4ff6-9f24-e8f4f335e433"></div>
                <input type="submit" value="Submit"/>
            </div>
        -->
    </section>
    <div id="logged" hidden="true">
        <div id="info">
            <button id="dms" onclick="getdms()">DMS</button>
            <div id="servers"></div>
        </div>

        <div id="chnnelInfo">
            <h3 id="connected">Disconnected</h3>
            <h2 id="chanName"></h2>
            <h3 id="chanDesc"></h3>
            <div id="channels"></div>
        </div>

        <div id="central">
            <div id="messages" hidden="true">
            </div>
            <input type="text" autocomplete="off" placeholder="Title" id="title" hidden="true" />
            <input type="text" autocomplete="off" placeholder="Description" id="desc" hidden="true" />
            <input type="text" autocomplete="off" placeholder="Color" id="color" hidden="true" />
            <h5 id="error" hidden="true"></h5>

            <div class="toolbar">
                <h5 id="replymsg" style="display:inline" hidden="true"></h5><button style="display:inline" hidden="true"
                    id=closereply onclick="document.getElementById('replymsg').innerText='';reply=''">X</button>
                <input type="file" id="upload"></input>

                <br>

                <button onclick="bonfire()">Re-establish websocket</button>
                <button onclick="getmessage()">Get messages</button>
                <button onclick="uIDs=[];usernames=[];pfpsrcs=[];getmessage();">Reload Usernames</button>
                <button onclick="embedmessage()">Send embed</button>
            </div>

            <div id="messagebar">
                <button onclick="contentToJson()">JSON</button>
                <input class="input-bar" type="text" autocomplete="off" placeholder="Start wasting your time" id="input">
                <button onclick="sendmessage()">Send</button>
            </div>
        </div>
    </div>
    <style>
        :root {
            --secondary-background: #1A1A1A;
        }

        *{
            margin: 0;
            box-sizing: border-box;
        }

        html {
            background-color: var(--background);
            color: var(--foreground);
            font-family: monospace
        }

        body{
            background: black;
            color: white;
            font-family: Arial, Helvetica, sans-serif;
            width: 100%;
            max-height: 100vh;
        }

        .login-section{
            display: grid;
            place-content: center;
            text-align: center;
            width: 100%;
            height: 100vh;
        }

        .login-logo{
            color: red;
            font-size: 5rem;
            margin-bottom: 3rem;
            /* font-family: monospace; */
        }

        .name{
            font-size: 3.5rem;
            text-transform: uppercase;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 3rem;
        }

        .login-put, .input-bar {
            border: 3px solid;
            background: black;
            color: var(--foreground);
            font-size: 1.2rem;
            outline: none;
            line-height: 200%;
            padding-left: 0.5rem;
            width: 400px;
        }

        #logged {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            height: 100vh;
        }

        #chnnelInfo{
            max-width: 13em;
        }

        #closereply {
            display: none
        }

        [id^=server],
        [id^=chan],
        [id^=dm] {
            width: 15em;
            outline: 0;
            border-color: rgba(0, 0, 0, 0)
        }

        [id^=chan]{
            width: 100%;
        }

        #dms, #servers{
            width: 100%;
        }

        .msg,
        .messagecont {
            word-break: break-all;
            white-space: pre-wrap;
            padding-bottom: 5px;
            max-width: 80% !important;
        }

        #author {
            display: inline-block;
        }

        #input,
        #author {
            color: var(--usernames);
            margin-left: 0%;
            border-left: 0%
        }

        #central {
            display: flex;
            flex-direction: column;
            margin-left: 3rem;
            width: 100%;
        }

        #channelDesc{
            font-size: 1rem;
        }

        #info {
            padding: 1rem;
            word-break: break-all !important;
        }

        button:hover {
            text-shadow: 0 -1px 0 darken(var(--accent), 15%);
            background: lighten(var(--accent), 5%);
        }

        .messagecont,
        .message {
            white-space: nowrap;
            display: block;
        }

        #replymsg {
            padding-bottom: 0px;
            display: block
        }

        img {
            max-width: 600px;
        }

        #messages {
            overflow: auto;
            backface-visibility: hidden;
            height: 45vw;
        }

        #channels {
            border: medium solid;
        }

        button {
            background-color: var(--secondary-background);
            color: var(--foreground)
        }

        .pfp {
            max-width: 50px;
            max-width: 50px;
        }

    </style>
    <script>
        let lastmessage;
        let embedSend = false;
        let sendRawJson = false;
        let uIDs = [];
        let usernames = [];
        let thechannel = "";
        let reply = "";
        let image = "";
        let theuser = "";
        let messages = [];
        let pfpsrcs = [];
        let thetoken;
        let tm;
        let socket;
        let typingtimeout;
        let istyping = false;
        let messcont;
        let errortimeout;

        if(localStorage.getItem("token") !=undefined){
                    thetoken=localStorage.getItem("token");
                    login();
        }

        async function login() {
            if (document.getElementById("token").value) {
                thetoken = document.getElementById("token").value;
                localStorage.setItem("token",thetoken)
            }
            bonfire()
            await fetch("https://api.revolt.chat/users/@me", {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET"
            })
                .then(response => response.json())
                .then(data => theuser = data)
                .catch(err => showError("INVALID TOKEN"))
            document.querySelector(".login-section").style.display = "none";
            document.getElementById("logged").hidden = false;
            document.getElementById("logged").style.display = "flex";
        }

        async function bonfire() {
            socket = new WebSocket("wss://ws.revolt.chat");
            socket.addEventListener('open', function (event) {
                socket.send(`{
                    "type": "Authenticate",
                    "token": "${thetoken}"
                }`);
                try {
                    setInterval(ping, 10000);
                } catch (error) { showError(error) }
            });

            socket.addEventListener('message', function (event) {
                data = JSON.parse(event.data)
                if (data.type == "Authenticated") {
                    document.getElementById("connected").innerText = "Connected"
                } else if (data.type == "Message") {
                    if (data.channel == thechannel) {
                        parsemessage(data);
                    }
                } else if (data.type == "Pong") {
                    pong()
                } else if (data.type == "Error") {
                    if (data.error == "InvalidSession") { showError("INVALID TOKEN"); } else { showError(data.error); }
                } else if (data.type == "Ready") {
                    console.log(JSON.stringify(data.servers))
                    getserver(data.servers);
                }
            });

            socket.addEventListener('error', function (event) {
                document.getElementById("connected").innerText = "Disconnected"
                showError("Disconnected")
            });

            socket.onclose = function (event) {
                document.getElementById("connected").innerText = "Disconnected";
                showError("Disconnected")
            }
        }

        function ping() {
            socket.send('{"type":"Ping","data":0}');
            tm = setTimeout(async function () {
                document.getElementById("connected").innerText = "Disconnected";
                showError("Disconnected")
                while (document.getElementById("connected") == "Disconnected") {
                    try { bonfire(); } catch (error) { showError(error) }
                    await sleep(5000);
                }
            }, 5000);
        }

        function pong() {
            clearTimeout(tm);
        }

        async function showError(error) {
            try { clearTimeout(errortimeout); } catch (error) { }
            document.getElementById("loginerror").innerText = error;
            document.getElementById("error").innerText = error;
            document.getElementById("loginerror").hidden = false;
            document.getElementById("error").hidden = false;
            errortimeout = setTimeout(function () {
                document.getElementById('error').hidden = true;
                document.getElementById('loginerror').hidden = true;
            }, 10000);
        }

        async function uploadToAutumn() {
            const files = document.getElementById("upload").files
            const formData = new FormData()
            formData.append('myFile', files[0])

            await fetch('https://autumn.revolt.chat/attachments', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    image = data.id;
                })
                .catch(error => {
                    showError(error)
                })
        }

        function embedmessage() {
            document.getElementById("title").hidden = false;
            document.getElementById("desc").hidden = false;
            document.getElementById("color").hidden = false;
            embedSend = true;
        }

        document.getElementById("input").onkeypress = function (event) {
            if (event.keyCode == 13 || event.which == 13) {
                sendmessage();
            } else {
                if (!istyping) {
                    clearTimeout(typingtimeout);
                    istyping = true
                    socket.send(`{
                        "type":"BeginTyping",
                        "channel":"${thechannel}"
                        }`);

                    typingtimeout = setTimeout(function () {
                        istyping = false;
                        socket.send(`{
                            "type":"EndTyping",
                            "channel":"${thechannel}"
                        }`);
                    }, 1000)
                }
            }
        };

        function contentToJson() {
            if (!sendRawJson) {
                sendRawJson = true;
            }
            else { sendRawJson = false; }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function sendmessage() {
            message = document.getElementById('input').value
            if (message.search(/ @[^ ]*/) != -1) {
                pings = /@[^ ]*/[Symbol.match](message)
                for (let i = 0; i < pings.length; i++) {
                    message = message.replace(pings[i], `<@${uIDs[usernames.indexOf(pings[i].replace("@", ""))]}>`)
                }
            }
            if (!(embedSend || sendRawJson || reply != "" || document.getElementById("upload").files[0])) {
                fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                    "credentials": "omit",
                    "headers": {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "x-session-token": thetoken
                    },
                    "body": `{
                    "content":"${message}"
                }`,
                    "method": "POST"
                })
                document.getElementById("input").value = ""
            }
            else {
                if (reply != "") {
                    fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                        "credentials": "omit",
                        "headers": {
                            "Accept": "*/*",
                            "Content-Type": "application/json",
                            "x-session-token": thetoken
                        },
                        "body": `{
                    "content":"${message}",
                    "replies":[{"id":"${reply}","mention":false}]
                }`,
                        "method": "POST"
                    })
                    document.getElementById("input").value = "";
                    reply = ""
                    document.getElementById('replymsg').innerText = '';
                    document.getElementById('replymsg').hidden = true
                } else {
                    if (document.getElementById("upload").files[0]) {
                        await uploadToAutumn();
                        await fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                            "credentials": "omit",
                            "headers": {
                                "Accept": "*/*",
                                "Content-Type": "application/json",
                                "x-session-token": thetoken
                            },
                            "body": `{
                    "content":"${message}",
                    "attachments":["${image}"]
                }`,
                            "method": "POST"
                        })
                        var file = document.getElementById("upload");
                        file.value = file.defaultValue;
                        image = ""
                        document.getElementById("input").value = ""
                    } else {
                        if (embedSend) {
                            fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                                "credentials": "omit",
                                "headers": {
                                    "Accept": "*/*",
                                    "Content-Type": "application/json",
                                    "x-session-token": thetoken
                                },
                                "body": `{
                    "nonce":"",
                    "content":"${message}",
                    "embeds":[
                        {
                            "title":"${document.getElementById("title").value}",
                            "description":"${document.getElementById("desc").value}",
                            "colour":"${document.getElementById("color").value}"
                        }
                    ]
                }`,
                                "method": "POST"
                            })
                            embedSend = false;
                            document.getElementById("title").hidden = true;
                            document.getElementById("desc").hidden = true;
                            document.getElementById("color").hidden = true;
                            document.getElementById("title").value = "";
                            document.getElementById("desc").value = "";
                            document.getElementById("color").value = "";
                        }
                        else {
                            fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                                "credentials": "omit",
                                "headers": {
                                    "Accept": "*/*",
                                    "Content-Type": "application/json",
                                    "x-session-token": thetoken
                                },
                                "body": document.getElementById("input").value,
                                "method": "POST"
                            })
                            sendRawJson = false;
                        }
                    }
                }
            }
        }

        function clearmessages() {
            messages = [];
            document.getElementById('messages').innerHTML = '';
            messcont = [];
        }

        async function getdms() {
            await fetch(`https://api.revolt.chat/users/dms`, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            })
                .then(response => response.json())
                .then(data => dm = (data))
                .catch(error => { showError(error) });
            document.getElementById('channels').innerHTML = "";
            for (let i = 0; i < dm.length; i++) {
                try {
                    if (dm[i].channel_type == "Group") {
                        document.getElementById('channels').innerHTML = `<button onclick="
                        theserver='';
                        clearmessages();
                        thechannel = '${dm[i]._id}';
                        getmessage()"
                        id="dm${i}">${dm[i]["name"]}</button>`
                            + document.getElementById('channels').innerHTML
                    } else {
                        if (dm[i].recipients[0] == theuser._id) {
                            id = dm[i].recipients[1]
                        } else {
                            id = dm[i].recipients[0]
                        }
                        document.getElementById('channels').innerHTML = `<button onclick="
                        theserver='';
                        clearmessages();
                        thechannel = '${dm[i]._id}';
                        getmessage()"
                        id="dm${i}">${id}</button>`
                            + document.getElementById('channels').innerHTML

                        fetch("https://api.revolt.chat/users/" + id, {
                            "credentials": "omit",
                            "headers": {
                                "Accept": "*/*",
                                "x-session-token": thetoken
                            },
                            "method": "GET",
                        }).then(response => response.json())
                            .then(data => document.getElementById(`dm${i}`).innerText = (data.username))
                    }
                } catch (error) {
                    showError(error)
                }
            }
        }

        async function getserver(server) {

            for (let i = 1; i < server.length; i++) {
                document.getElementById(`servers`).innerHTML +=
                    `<button onclick="theserver = '${server[i - 1]._id}';getchannel()"
                id="server${i}">${server[i - 1].name}</button>`;
            }
        }

        async function getchannel() {
            document.getElementById(`channels`).innerHTML = ""
            await fetch(`https://api.revolt.chat/servers/${theserver}/`, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            }).then(response => response.json())
                .then(data => chann = (data.channels))
            for (let i = 0; i < chann.length; i++) {
                document.getElementById(`channels`).innerHTML += `<button onclick="
                thechannel = '${chann[i]}';
                clearmessages();
                getmessage();"
                id="chann${i}">${chann[i]}</button>`;
            }
            for (let i = 0; i < chann.length; i++) {
                fetch(`https://api.revolt.chat/channels/${chann[i]}/`, {
                    "credentials": "omit",
                    "headers": {
                        "Accept": "*/*",
                        "x-session-token": thetoken
                    },
                    "method": "GET",
                }).then(response => response.json())
                    .then(data => {
                        if (data.channel_type === "VoiceChannel") {
                            document.getElementById(`chann${i}`).remove(); return;
                        }
                        document.getElementById(`chann${i}`).innerText = data.name
                    });
            }
        }

        async function parsemessage(message) {
            try {
                let pfpsrc = ""
                let username = ""
                let img = ""
                let replyinmsg = ""
                if (message.attachments) {
                    image = message.attachments;
                    img = `<br><img src="https://autumn.revolt.chat/attachments/${image[0]._id}/${image[0].filename}">`
                }
                if (message.replies) {
                    if (messages.indexOf(!message.replies[0]._id) == -1) {
                        await fetch(`https://api.revolt.chat/channels/${thechannel}/messages/${message.replies[0]}`, {
                            "credentials": "omit",
                            "headers": {
                                "Accept": "*/*",
                                "x-session-token": thetoken
                            },
                            "method": "GET",
                        }).then(response => response.json())
                            .then(data => replyinmsg = ("> " + data.content))
                    } else {
                        replyinmsg = "> " + messcont[messages.indexOf(message.replies[0])]
                    }
                }
                if (message.masquerade) {
                    try {
                        username = message.masquerade.name;
                        pfpsrc = message.masquerade.avatar;
                    } catch (error) { showError(JSON.stringify(message) + error) }
                } else if (uIDs.indexOf(message.author) === -1) {
                    await fetch(`https://api.revolt.chat/users/${message.author}`, {
                        "credentials": "omit",
                        "headers": {
                            "Accept": "*/*",
                            "x-session-token": thetoken,
                            "Cache-Control": "private"
                        },
                        "method": "GET",
                    }).then(response => response.json())
                        .then(data => {
                            if (data.avatar) {
                                pfpsrc = `https://autumn.revolt.chat/avatars/${data.avatar._id}/${data.avatar.filename}`;
                            }
                            else {
                                pfpsrc = `https://api.revolt.chat/users/${message.author}/default_avatar`
                            }
                            username = data.username
                            pfpsrcs.push(pfpsrc)
                            usernames.push(data.username)
                            uIDs.push(data._id)
                        });
                } else {
                    pfpsrc = pfpsrcs[uIDs.indexOf(message.author)]
                    username = usernames[uIDs.indexOf(message.author)]
                }
                if(message.reactions){
                    console.log(message.reactions)
                    for(let i=0;i<message.reactions.length;i++){
                        console.log(message.reactions[i])
                    }
                }
                document.getElementById("messages").innerHTML = document.getElementById("messages").innerHTML + `
                <div class="messagecont" onclick="button=document.getElementById('reply${message._id}'); if(button.hidden){button.hidden=false}else{button.hidden=true}">
                    <h6 hidden="${replymsg != "" ? "true" : "false"}" id="replymsg">${replyinmsg}</h6>
                    <div class="message">
                        ${lastmessage != message.author ? `<img src="${pfpsrc}" class="pfp"></img>
                        <h4 id="author">${username}</h4>` : ""}
                        <button hidden=true class="reply" id="reply${message._id}" onclick="
                        reply='${message._id}';
                        document.getElementById('replymsg').innerText='> ${message.content}';
                        document.getElementById('replymsg').hidden=false">
                            reply</button>
                        <h5 class="msg">${message.content}${img}</h5>
                    </div>
                </div>`
                messages.push(message._id);
                messcont.push(message.content)
                lastmessage = message.author
            } catch (error) { showError(error) }
        }

        async function getmessage() {
            fetch(`https://api.revolt.chat/channels/${thechannel}`, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            }).then(response => response.json())
                .then(data => {
                    if (data.channel_type == "DirectMessage") { document.getElementById("chanName").innerText = data.recipients[0] } else { document.getElementById("chanName").innerText = data.name; }
                    if (data.description) { document.getElementById("chanDesc").innerText = data.description };
                })

            document.getElementById("messages").hidden = false;
            document.getElementById("messages").innerHTML = "";
            await fetch(`https://api.revolt.chat/channels/${thechannel}/messages?include_users=true`, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            }).then(response => response.json())
                .then(data => {mess = (data.messages); users = (data.users)})
            
            for(let i=0;i<users.length;i++){
                console.log(users[i])
                if(uIDs.indexOf(users[i]._id) === -1){
                    uIDs.push(users[i]._id)
                    usernames.push(users[i].username)
                    if(users[i].avatar){
                        pfpsrcs.push(`https://autumn.revolt.chat/avatars/${users[i].avatar._id}/${users[i].avatar.filename}`)
                    } else {
                        pfpsrcs.push(`https://autumn.revolt.chat/avatars/${users[i]._id}/default_avatar`)
                    }
                }
            }
            mess.reverse()
            for (let i = 1; i <= mess.length; i++) {
                await parsemessage(mess[i - 1])
            }
        }
    </script>
</body>
</html>
